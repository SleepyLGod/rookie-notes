# ğŸ§ Bloom Filter

* ç©ºé—´æ•ˆç‡é«˜çš„æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œç”¨æ¥æ£€æŸ¥ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­
* å¯¹äºä¸€ä¸ªå…ƒç´ æ£€æµ‹æ˜¯å¦å­˜åœ¨çš„è°ƒç”¨ï¼ŒBloomFilterä¼šå‘Šè¯‰è°ƒç”¨è€…ä¸¤ä¸ªç»“æœä¹‹ä¸€ï¼šå¯èƒ½å­˜åœ¨æˆ–è€…ä¸€å®šä¸å­˜åœ¨

åœ¨åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å±äºæŸä¸ªé›†åˆæ—¶ï¼Œæœ‰å¯èƒ½ä¼šæŠŠä¸å±äºè¿™ä¸ªé›†åˆçš„å…ƒç´ è¯¯è®¤ä¸ºå±äºè¿™ä¸ªé›†åˆï¼ˆ**false positive**ï¼‰ã€‚å› æ­¤ï¼ŒBloom Filterä¸é€‚åˆé‚£äº›â€œé›¶é”™è¯¯â€çš„åº”ç”¨åœºåˆã€‚è€Œåœ¨èƒ½å®¹å¿ä½é”™è¯¯ç‡çš„åº”ç”¨åœºåˆä¸‹ï¼ŒBloom Filteré€šè¿‡æå°‘çš„é”™è¯¯æ¢å–äº†å­˜å‚¨ç©ºé—´çš„æå¤§èŠ‚çœã€‚

## **BitMap & Bloom Filter**

ä¸ºå‡å°‘å†…å­˜å¼€é”€ï¼Œä»…ä»…é’ˆå¯¹çŸ¥é“æ˜¯å¦å­˜åœ¨ï¼Œä½¿ç”¨ä½å›¾ç®—æ³•ï¼š

å¦‚éœ€æ±‚æ˜¯è¦æ ¹æ®ç½‘é¡µURLï¼ˆå­—èŠ‚æ•°å¾ˆå¤§ï¼‰åˆ¤æ–­ç½‘é¡µæ˜¯å¦åœ¨é»‘åå•ï¼š

æ¯ä¸ªmapå€¼éƒ½ä½¿ç”¨1bitï¼Œè¿™æ ·å¤§å¤§é™ä½äº†å†…å­˜å¼€é”€ï¼Œå…·ä½“åšæ³•æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªHashå‡½æ•°å°†URLæ˜ å°„åˆ°å¤§å°ä¸ºnçš„bitæ•°ç»„ä¸­ï¼Œå¹¶ç½®ç›¸åº”ä½ç½®ä¸ºTrue

![](https://s2.loli.net/2022/07/24/5YhNiEVmXLu2Qvs.png)

å¯ä»¥åœ¨å°½å¯èƒ½ä½çš„å†…å­˜å¼€é”€ä¸‹ï¼Œå®ç°**Oï¼ˆ1ï¼‰**æ—¶é—´çš„åˆ¤æ–­URLæ˜¯å¦å­˜åœ¨é»‘åå•ä¸­ã€‚

ä½†ä¸å¾—ä¸é¢å¯¹çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå³ä½¿é‡‡å–å†å¥½çš„å“ˆå¸Œå‡½æ•°ï¼Œéƒ½ä¼šå‡ºç°å“ˆå¸Œå†²çªçš„æƒ…å†µï¼Œåœ¨æŸ¥è¯¢é˜¶æ®µå‡ºç°å“ˆå¸Œå†²çªæ„å‘³ç€**æŸ¥è¯¢é”™è¯¯ï¼Œä¼šè¿”å›ä¸€ä¸ªé”™è¯¯çš„ç»“æœï¼Œè€Œæƒ³å°½å¯èƒ½çš„é™ä½å“ˆå¸Œå†²çªï¼Œæˆ‘ä»¬éœ€è¦ä½å›¾å¤§å°æ¯”é»‘åå•ä¸­URLæ•°é‡å¤§çš„å¤šï¼Œæˆ‘ä»¬è€ƒè™‘éšæœºå“ˆå¸Œçš„æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ç¢°æ’çš„æ¦‚ç‡æ˜¯ï¼šé»‘åå•URLæ•°é‡/ä½å›¾å¤§å°ã€‚æ‰€ä»¥è¦æƒ³æŸ¥è¯¢å‡†ç¡®ç‡é«˜ï¼Œåˆå¸¦æ¥äº†æ›´é«˜çš„å†…å­˜å¼€é”€ï¼Œè€Œå¯ä»¥æœ‰æ•ˆæ”¹å–„è¿™ç§æƒ…å†µçš„ä¸€ç§æ•°æ®ç»“æ„å°±æ˜¯ï¼ˆBloom Filterï¼‰**

ä½¿ç”¨**å¤šä¸ª**Hashå‡½æ•°å¯¹æ•°æ®è¿›è¡Œå“ˆå¸Œæ“ä½œï¼ˆå¦‚ä¸‹å›¾ä½¿ç”¨äº†ä¸¤ä¸ªhashå‡½æ•°ï¼‰ï¼Œè¿™æ ·å¾—å‡ºå¤šä¸ªä½ç½®ä¸ºTrueï¼Œç›¸æ¯”ä½å›¾å®ƒåœ¨æœ‰é™çš„ç©ºé—´å†…ï¼Œå°½å¯èƒ½çš„é™ä½äº†æŸ¥è¯¢å¤±è´¥çš„å¯èƒ½ï¼Œè¿™ä¸€ç‚¹å¯ä»¥ä»ä¿¡æ¯ç†µçš„è§’åº¦æ¥çœ‹ï¼Œæ¯ä¸€ä¸ªä½ç½®æ‰€åŒ…å«çš„ä¿¡æ¯æ›´åŠ å¤šäº†ï¼Œæ‰€ä»¥æ¯”èµ·ä½å›¾æ¥è¯´ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¯¹ç©ºé—´çš„åˆ©ç”¨ç‡ä¹Ÿå˜å¤§äº†

![image-20210715164606827](https://s2.loli.net/2022/07/24/fPCbeqjgmAErS4V.png)

## **é›†åˆè¡¨ç¤ºå’Œå…ƒç´ æŸ¥è¯¢**

ä¸‹é¢æˆ‘ä»¬å…·ä½“æ¥çœ‹Bloom Filteræ˜¯å¦‚ä½•ç”¨ä½æ•°ç»„è¡¨ç¤ºé›†åˆçš„ã€‚åˆå§‹çŠ¶æ€æ—¶ï¼ŒBloom Filteræ˜¯ä¸€ä¸ªåŒ…å«mä½çš„ä½æ•°ç»„ï¼Œæ¯ä¸€ä½éƒ½ç½®ä¸º0ã€‚

![img](https://s2.loli.net/2022/07/12/pJo4ygWAaXqTvxR.jpg)

ä¸ºäº†è¡¨è¾¾`S={x1, x2,â€¦,xn}`è¿™æ ·ä¸€ä¸ªnä¸ªå…ƒç´ çš„é›†åˆï¼ŒBloom Filterä½¿ç”¨kä¸ªç›¸äº’ç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°ï¼ˆHash Functionï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«å°†é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ æ˜ å°„åˆ°{1,â€¦,m}çš„èŒƒå›´ä¸­ã€‚å¯¹ä»»æ„ä¸€ä¸ªå…ƒç´ `x`ï¼Œç¬¬`i`ä¸ªå“ˆå¸Œå‡½æ•°æ˜ å°„çš„ä½ç½®`hi(x)`å°±ä¼šè¢«ç½®ä¸º1ï¼ˆ1â‰¤iâ‰¤kï¼‰ã€‚æ³¨æ„ï¼Œå¦‚æœä¸€ä¸ªä½ç½®å¤šæ¬¡è¢«ç½®ä¸º1ï¼Œé‚£ä¹ˆåªæœ‰**ç¬¬ä¸€æ¬¡**ä¼šèµ·ä½œç”¨ï¼Œåé¢å‡ æ¬¡å°†æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œ_k=3_ï¼Œä¸”æœ‰ä¸¤ä¸ªå“ˆå¸Œå‡½æ•°é€‰ä¸­åŒä¸€ä¸ªä½ç½®ï¼ˆä»å·¦è¾¹æ•°ç¬¬äº”ä½ï¼‰ã€‚

![img](https://s2.loli.net/2022/07/24/NWEUT5amSiZdc9f.jpg)

åœ¨**æ’å…¥**ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šä½¿ç”¨kä¸ªhashå‡½æ•°ï¼Œæ¥è®¡ç®—å‡ºkä¸ªåœ¨bit arrayä¸­çš„ä½ç½®ï¼Œç„¶åï¼Œå°†bit arrayä¸­è¿™äº›ä½ç½®çš„bitéƒ½ç½®ä¸º1

åœ¨**åˆ¤æ–­**yæ˜¯å¦å±äºè¿™ä¸ªé›†åˆæ—¶ï¼Œæˆ‘ä»¬**å¯¹yåº”ç”¨kæ¬¡å“ˆå¸Œå‡½æ•°**ï¼Œå¦‚æœ**æ‰€æœ‰`hi(y)`çš„ä½ç½®éƒ½æ˜¯1ï¼ˆ1â‰¤iâ‰¤kï¼‰**ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºyæ˜¯é›†åˆä¸­çš„å…ƒç´ ï¼Œå¦åˆ™å°±è®¤ä¸ºyä¸æ˜¯é›†åˆä¸­çš„å…ƒç´ ã€‚ä¸‹å›¾ä¸­`y1`å°±ä¸æ˜¯é›†åˆä¸­çš„å…ƒç´ ã€‚**`y2`æˆ–è€…å±äºè¿™ä¸ªé›†åˆï¼Œæˆ–è€…åˆšå¥½æ˜¯ä¸€ä¸ªfalse positive**

![img](https://s2.loli.net/2022/07/24/7Cld2BObSRMIT5r.jpg)

ä¸å…è®¸æœ‰**åˆ é™¤**æ“ä½œï¼Œå› ä¸ºåˆ é™¤åï¼Œå¯èƒ½ä¼šé€ æˆåŸæ¥å­˜åœ¨çš„å…ƒç´ è¿”å›ä¸å­˜åœ¨ï¼Œè¿™ä¸ªæ˜¯ä¸å…è®¸çš„

ä¸å…è®¸åˆ é™¤çš„æœºåˆ¶ä¼šå¯¼è‡´å…¶ä¸­çš„æ— æ•ˆå…ƒç´ å¯èƒ½ä¼šè¶Šæ¥è¶Šå¤šï¼Œå³å®é™…å·²ç»åœ¨ç£ç›˜åˆ é™¤ä¸­çš„å…ƒç´ ï¼Œä½†åœ¨`bloomfilter`ä¸­è¿˜è®¤ä¸ºå¯èƒ½å­˜åœ¨ï¼Œè¿™ä¼šé€ æˆè¶Šæ¥è¶Šå¤šçš„false positiveï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä¸€èˆ¬ä¼šåºŸå¼ƒåŸæ¥çš„`BloomFilter`ï¼Œé‡æ–°æ„å»ºä¸€ä¸ªæ–°çš„`BloomFilter`

å¦‚æœè¦å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒåˆ é™¤ï¼Œé‚£ä¹ˆæ€ä¹ˆåŠå‘¢ï¼Ÿ

æœ‰ä¸€ä¸ªå«åš ``` `**`Counting Bloom Filter`**:

å®ƒç”¨ä¸€ä¸ª counter æ•°ç»„æ›¿æ¢æ•°ç»„çš„æ¯”ç‰¹ä½ï¼Œè¿™æ ·ä¸€æ¯”ç‰¹çš„ç©ºé—´å°±è¢«æ‰©å¤§æˆäº†ä¸€ä¸ªè®¡æ•°å™¨, ç”¨å¤šå ç”¨å‡ å€çš„å­˜å‚¨ç©ºé—´çš„ä»£ä»·ï¼Œç»™ Bloom Filter å¢åŠ äº†åˆ é™¤æ“ä½œã€‚

ä½†æ˜¯è¿˜æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ã€‚

## **å¯¹æ¯”**

å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œå¦‚`hashmap`ï¼Œ`set`ï¼Œ`bit array`éƒ½èƒ½ç”¨æ¥æµ‹è¯•ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºä¸€ä¸ªé›†åˆä¸­

* å¯¹äº`hashmap`ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**æŒ‡é’ˆæ•°ç»„**ï¼Œä¸€ä¸ªæŒ‡é’ˆçš„å¼€é”€æ˜¯`sizeof(void *)`ï¼Œåœ¨64bitçš„ç³»ç»Ÿä¸Šæ˜¯**64ä¸ªbit**ï¼Œå¦‚æœé‡‡ç”¨å¼€é“¾æ³•å¤„ç†å†²çªçš„è¯ï¼Œåˆéœ€è¦é¢å¤–çš„æŒ‡é’ˆå¼€é”€ï¼Œè€Œå¯¹äº`BloomFilter`æ¥è®²ï¼Œè¿”å›å¯èƒ½å­˜åœ¨çš„æƒ…å†µä¸­ï¼Œå¦‚æœå…è®¸æœ‰1%çš„é”™è¯¯ç‡çš„è¯ï¼Œæ¯ä¸ªå…ƒç´ å¤§çº¦éœ€è¦10bitçš„å­˜å‚¨ç©ºé—´ï¼Œæ•´ä¸ª**å­˜å‚¨ç©ºé—´çš„å¼€é”€**å¤§çº¦æ˜¯`hashmap`çš„15%å·¦å³
* å¯¹äº`set`:
  * å¦‚æœé‡‡ç”¨`hashmap`æ–¹å¼å®ç°ï¼Œæƒ…å†µåŒä¸Š
  * å¦‚æœé‡‡ç”¨**å¹³è¡¡æ ‘**æ–¹å¼å®ç°ï¼Œ**ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦ä¸€ä¸ªæŒ‡é’ˆå­˜å‚¨æ•°æ®çš„ä½ç½®ï¼Œä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘å…¶å­èŠ‚ç‚¹**ï¼Œå› æ­¤å¼€é”€ç›¸å¯¹äº`hashmap`æ¥è®²æ˜¯æ›´å¤šçš„
* å¯¹äº`bit array`ï¼Œå¯¹äºæŸä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œ**å…ˆå¯¹å…ƒç´ åšhashï¼Œå–æ¨¡å®šä½åˆ°å…·ä½“çš„bit**ï¼Œå¦‚æœè¯¥bitä¸º1ï¼Œåˆ™è¿”å›å…ƒç´ å­˜åœ¨ï¼Œå¦‚æœè¯¥bitä¸º0ï¼Œåˆ™è¿”å›æ­¤å…ƒç´ ä¸å­˜åœ¨ã€‚å¯ä»¥çœ‹å‡ºï¼Œåœ¨è¿”å›å…ƒç´ å­˜åœ¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä¼šæœ‰**è¯¯åˆ¤**çš„ï¼Œå¦‚æœè¦è·å¾—å’ŒBloomFilterç›¸åŒçš„è¯¯åˆ¤ç‡ï¼Œåˆ™éœ€è¦æ¯”BloomFilter**æ›´å¤§çš„å­˜å‚¨ç©ºé—´**

**åŠ£åŠ¿**ï¼š

* ç›¸å¯¹äº`hashmap`å’Œ`set`ï¼Œ`BloomFilter`åœ¨è¿”å›å…ƒç´ å¯èƒ½å­˜åœ¨çš„æƒ…å†µä¸­ï¼Œæœ‰ä¸€å®šçš„è¯¯åˆ¤ç‡ï¼Œè¿™æ—¶å€™ï¼Œè°ƒç”¨è€…åœ¨è¯¯åˆ¤çš„æ—¶å€™ï¼Œä¼šåšä¸€äº›ä¸å¿…è¦çš„å·¥ä½œï¼Œè€Œ**å¯¹äº`hashmap`å’Œ`set`ï¼Œä¸ä¼šå­˜åœ¨è¯¯åˆ¤æƒ…å†µ**
* å¯¹äº`bit array`ï¼Œ`BloomFilter`åœ¨æ’å…¥å’ŒæŸ¥æ‰¾å…ƒç´ æ˜¯å¦å­˜åœ¨æ—¶ï¼Œéœ€è¦åšå¤šæ¬¡hashï¼Œè€Œbit arrayåªéœ€è¦åšä¸€æ¬¡hashï¼Œå®é™…ä¸Šï¼Œ**bit arrayå¯ä»¥çœ‹åšæ˜¯`BloomFilter`çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µ**

**ä»¥ä¸€ä¸ªä¾‹å­**å…·ä½“æè¿°ä½¿ç”¨BloomFilterçš„åœºæ™¯ï¼Œä»¥åŠåœ¨æ­¤åœºæ™¯ä¸‹ï¼ŒBloomFilterçš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚

ä¸€ç»„å…ƒç´ å­˜åœ¨äºç£ç›˜ä¸­ï¼Œæ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œåº”ç”¨ç¨‹åºå¸Œæœ›åœ¨å…ƒç´ ä¸å­˜åœ¨çš„æ—¶å€™å°½é‡ä¸è¯»ç£ç›˜ã€‚

* æ­¤æ—¶ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­æ„å»ºè¿™äº›ç£ç›˜æ•°æ®çš„BloomFilterï¼Œå¯¹äºä¸€æ¬¡è¯»æ•°æ®çš„æƒ…å†µï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ ç§æƒ…å†µï¼š
  * è¯·æ±‚çš„å…ƒç´ ä¸åœ¨ç£ç›˜ä¸­ï¼Œå¦‚æœBloomFilterè¿”å›ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåº”ç”¨ä¸éœ€è¦èµ°è¯»ç›˜é€»è¾‘ï¼Œå‡è®¾æ­¤æ¦‚ç‡ä¸ºP1ï¼›**å¦‚æœBloomFilterè¿”å›å¯èƒ½å­˜åœ¨ï¼Œé‚£ä¹ˆå±äºè¯¯åˆ¤æƒ…å†µï¼Œå‡è®¾æ­¤æ¦‚ç‡ä¸ºP2**
  * è¯·æ±‚çš„å…ƒç´ åœ¨ç£ç›˜ä¸­ï¼ŒBloomFilterè¿”å›å­˜åœ¨ï¼Œå‡è®¾æ­¤æ¦‚ç‡ä¸ºP3
* å¦‚æœä½¿ç”¨hashmapæˆ–è€…setçš„æ•°æ®ç»“æ„ï¼Œæƒ…å†µå¦‚ä¸‹ï¼š
  * è¯·æ±‚çš„æ•°æ®ä¸åœ¨ç£ç›˜ä¸­ï¼Œåº”ç”¨ä¸èµ°è¯»ç›˜é€»è¾‘ï¼Œæ­¤æ¦‚ç‡ä¸ºP1+P2
  * è¯·æ±‚çš„å…ƒç´ åœ¨ç£ç›˜ä¸­ï¼Œåº”ç”¨èµ°è¯»ç›˜é€»è¾‘ï¼Œæ­¤æ¦‚ç‡ä¸ºP3

å‡è®¾åº”ç”¨ä¸è¯»ç›˜é€»è¾‘çš„å¼€é”€ä¸ºC1ï¼Œèµ°è¯»ç›˜é€»è¾‘çš„å¼€é”€ä¸ºC2ï¼Œé‚£ä¹ˆï¼ŒBloomFilter å’Œ hashmap çš„å¼€é”€ä¸º

```apl
Cost(BloomFilter) = P1 * C1 + (P2 + P3) * C2
Cost(HashMap) = (P1 + P2) * C1 + P3 * C2;

Delta = Cost(BloomFilter) - Cost(HashMap)
      = P2 * (C2 - C1)
```

å› æ­¤ï¼ŒBloomFilter ç›¸å½“äºä»¥å¢åŠ `P2 * (C2 - C1)`çš„æ—¶é—´å¼€é”€ï¼Œæ¥è·å¾—ç›¸å¯¹äºhashmapè€Œè¨€æ›´å°‘çš„ç©ºé—´å¼€é”€ã€‚

æ—¢ç„¶**P2æ˜¯å½±å“BloomFilteræ€§èƒ½å¼€é”€çš„ä¸»è¦å› ç´ **ï¼Œé‚£ä¹ˆBloomFilterè®¾è®¡æ—¶å¦‚ä½•é™ä½æ¦‚ç‡P2ï¼ˆå³false positive probabilityï¼‰å‘¢

## **å‚æ•°å–å€¼**

å®é™…åº”ç”¨å…³æ³¨ false positiveï¼Œå› ä¸ºå’Œé¢å¤–å¼€é”€æœ‰å…³ï¼Œå®é™…åº”ç”¨ä¸­æœŸæœ›ç»™å®šä¸€ä¸ª false positive probability å’Œå°†è¦æ’å…¥çš„å…ƒç´ çš„æ•°é‡

ä¾ç„¶æ˜¯ä¸Šæ–‡çš„ m, n, kï¼Œfalse positive probability = p

**=> :**

å¦‚æœéœ€è¦**æœ€å°åŒ–** false positive probabilityï¼Œåˆ™kçš„å–å€¼å¦‚ä¸‹ï¼ˆâ‘ ï¼‰

```apl
k = m * ln2 / n;  
```

è€Œ**pçš„å–å€¼**ï¼Œå’Œmï¼Œnåˆæœ‰å¦‚ä¸‹å…³ç³»ï¼ˆâ‘¡ï¼‰

```apl
m = - n * lnp / (ln2) ^ 2 
```

æŠŠâ‘ ä»£å…¥â‘¡ï¼Œå¾—å‡ºç»™å®šnå’Œpï¼Œkçš„å–å€¼åº”è¯¥ä¸º

```apl
k = -lnp / ln2
```

æœ€åï¼Œä¹ŸåŒæ ·å¯ä»¥è®¡ç®—å‡ºm

## BloomFilterå®ç°åŠä¼˜åŒ–

### **Basic version**

DS:

```cpp
template <typename T>
class BloomFilter {
    public:
    BloomFilter(const int32_t n, const double false_positive_p);
    void insert(const T &key);
    bool key_may_match(const T &key);
    
    private:
    std::vector<char> bits_; // æ¨¡ä»¿bit array
    int32_t k_;
    int32_t m_;
    int32_t n_;
    double p_;
}

// init:
template <typename T>
BoomFilter<T>::BoomFilter(const int32_t n, const double false_positive_p)
    : bits_(), k_(0), m(0), n_(n), p_(false_positive_p) {
        k_ = static_cast<int32_t>(-std::log(p_) / std::log(2));
        m_ = static_cast<int32_t>(k_ * n * 1.0 / std::log(2));
        bits_.resize((m_ + 7) / 8, 0);
}

// insert:
// è®¾ç½®æ¯ä¸ªhashå‡½æ•°è®¡ç®—å‡ºæ¥çš„bitä¸º1
template<typename T>
void BloomFilter<T>::insert(const T &key) {
  uint32_t hash_val = 0xbc9f1d34;
  for (int i = 0; i < k_; ++i) {
    hash_val = key.hash(hash_val);
    const uint32_t bit_pos = hash_val % m_;
    bits_[bit_pos/8] |= 1 << (bit_pos % 8);
  }    
}
    
// check
// è®¡ç®—æ¯ä¸ªhashå‡½æ•°å¯¹åº”çš„bitçš„å€¼ï¼Œå¦‚æœå…¨ä¸º1ï¼Œåˆ™è¿”å›å­˜åœ¨ï¼›å¦åˆ™ï¼Œè¿”å›ä¸å­˜åœ¨
template<typename T>
bool BloomFilter<T>::key_may_match(const T &key) {
  uint32_t hash_val = 0xbc9f1d34;
  for (int i = 0; i < k_; ++i) {
    hash_val = key.hash(hash_val);
    const uint32_t bit_pos = hash_val % m_;
    if ((bits_[bit_pos / 8] & (1 << (bit_pos % 8))) == 0) {
      return false;
    }
  }
  return true;
}
```

**æ•´ä¸ªBloomFilteråŒ…å«ä¸‰ä¸ªæ“ä½œï¼š**

* åˆå§‹åŒ–ï¼šå³ä¸Šè¿°ä»£ç ä¸­çš„æ„é€ å‡½æ•°
* æ’å…¥ï¼šå³ä¸Šè¿°ä»£ç ä¸­çš„insert
* åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼šå³ä¸Šè¿°ä»£ç ä¸­çš„key\_may\_match

### **Optimization**

å¤šæ¬¡è°ƒç”¨äº†`hash_func`å‡½æ•°ï¼Œè¿™å¯¹äºè®¡ç®—æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²çš„hashçš„å¼€é”€æ˜¯æ¯”è¾ƒå¤§çš„

å¤šæ¬¡è°ƒç”¨äº†hash\_funcå‡½æ•°ï¼Œè¿™å¯¹äºè®¡ç®—æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²çš„hashçš„å¼€é”€æ˜¯æ¯”è¾ƒå¤§çš„

å¯ä»¥é‡‡ç”¨**ä¸¤æ¬¡hash**çš„æ–¹å¼æ¥æ›¿ä»£ä¸Šè¿°çš„å¤šæ¬¡çš„è®¡ç®—:

ä¾‹å¦‚`insert_optimized`:

```cpp
template<typename T>
void BloomFilter<T>::insert2(const T &key) {
    uint32_t hash_val = key.hash(0xbc9f1d34); // 1st
    const uint32_t delta = (hash_val >> 17) | (hash_val << 15); // 2nd
    for (int i = 0; i < k; ++i) {
        const uint32_t bit_pos = hash_val % m_;
        bits_[bit_pos/8] |= 1 << (bit_pos % 8);
        hash_val += delta;
    }
}
```

å…ˆç”¨é€šå¸¸çš„hashå‡½æ•°è®¡ç®—ä¸€æ¬¡ï¼Œç„¶åï¼Œä½¿ç”¨ç§»ä½æ“ä½œè®¡ç®—ä¸€æ¬¡ï¼Œæœ€åï¼Œkæ¬¡è®¡ç®—çš„æ—¶å€™ï¼Œä¸æ–­ç´¯åŠ ä¸¤æ¬¡çš„ç»“æœ

ä¼˜åŒ–åï¼Œæœ€å¤§çš„false positive probabilityå¢é•¿ï¼Œå¯ä»¥å¢åŠ kæ¥å¼¥è¡¥ï¼Œå› ä¸ºä¼˜åŒ–åçš„hashç®—æ³•ï¼Œåœ¨kå¢é•¿æ—¶ï¼Œå¸¦æ¥çš„å¼€é”€ç›¸å¯¹æ¥è®²ä¸å¤§

> P.S.:
>
> int\_t ä¸ºä¸€ä¸ªç»“æ„çš„æ ‡æ³¨ï¼Œå¯ä»¥ç†è§£ä¸ºtype/typedefçš„ç¼©å†™ï¼Œè¡¨ç¤ºå®ƒæ˜¯é€šè¿‡typedefå®šä¹‰çš„ï¼Œè€Œä¸æ˜¯ä¸€ç§æ–°çš„æ•°æ®ç±»å‹ã€‚å› ä¸ºè·¨å¹³å°ï¼Œä¸åŒçš„å¹³å°ä¼šæœ‰ä¸åŒçš„å­—é•¿ï¼Œæ‰€ä»¥åˆ©ç”¨[é¢„ç¼–è¯‘](https://so.csdn.net/so/search?q=%E9%A2%84%E7%BC%96%E8%AF%91\&spm=1001.2101.3001.7020)å’Œtypedefå¯ä»¥æœ€æœ‰æ•ˆçš„ç»´æŠ¤ä»£ç 
>
> * `int8_t` : typedef signed char;
> * `uint8_t` : typedef unsigned char;
> * `int16_t` : typedef signed short ;
> * `uint16_t` : typedef unsigned short ;
> * `int32_t` : typedef signed int;
> * `uint32_t` : typedef unsigned int;
> * `int64_t` : typedef signed long long;
> * `uint64_t` : typedef unsigned long long;
>
> **`size_t`ä¸`ssize_t`**
>
> `size_t`ä¸»è¦ç”¨äºè®¡æ•°ï¼Œå¦‚`sizeof()`å‡½æ•°è¿”å›å€¼ç±»å‹å³ä¸º`size_t`,åœ¨ä¸åŒä½çš„æœºå™¨ä¸­æ‰€å çš„ä½æ•°ä¹Ÿä¸åŒ
>
> `size_t`æ˜¯æ— ç¬¦å·æ•°ï¼Œ`ssize_t`æ˜¯æœ‰ç¬¦å·æ•°ã€‚
>
> åœ¨32ä½æœºå™¨ä¸­å®šä¹‰ä¸ºï¼štypedef unsigned int size\_t; ï¼ˆ4ä¸ªå­—èŠ‚ï¼‰ åœ¨64ä½æœºå™¨ä¸­å®šä¹‰ä¸ºï¼štypedef unsigned long size\_t;ï¼ˆ8ä¸ªå­—èŠ‚ï¼‰
>
> ç”±äºsize\_tæ˜¯æ— ç¬¦å·æ•°ï¼Œå› æ­¤ï¼Œ**å½“å˜é‡æœ‰å¯èƒ½ä¸ºè´Ÿæ•°æ—¶ï¼Œå¿…é¡»ä½¿ç”¨`ssize_t`**:
>
> å› ä¸ºå½“æœ‰ç¬¦å·æ•´å‹å’Œæ— ç¬¦å·æ•´å‹è¿›è¡Œè¿ç®—æ—¶ï¼Œæœ‰ç¬¦å·æ•´å‹ä¼šå…ˆè‡ªåŠ¨è½¬åŒ–æˆæ— ç¬¦å·
>
> **å››ç§ç±»å‹è½¬æ¢è¿ç®—ç¬¦**

| å…³é”®å­—                | è¯´æ˜                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `static_cast`      | ç”¨äº**è‰¯æ€§**è½¬æ¢ï¼Œä¸€èˆ¬ä¸ä¼šå¯¼è‡´æ„å¤–å‘ç”Ÿï¼Œé£é™©å¾ˆä½ï¼š åŸæœ‰çš„è‡ªåŠ¨ç±»å‹è½¬æ¢, void æŒ‡é’ˆå’Œå…·ä½“ç±»å‹æŒ‡é’ˆä¹‹é—´çš„è½¬æ¢, æœ‰è½¬æ¢æ„é€ å‡½æ•°æˆ–è€…ç±»å‹è½¬æ¢å‡½æ•°çš„ç±»ä¸å…¶å®ƒç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œä¸è¿‡**static\_cast ä¸èƒ½ç”¨äºæ— å…³ç±»å‹ä¹‹é—´çš„è½¬æ¢**ï¼ˆä¸¤ä¸ªå…·ä½“ç±»å‹æŒ‡é’ˆä¹‹é—´çš„è½¬æ¢ã€int å’ŒæŒ‡é’ˆä¹‹é—´çš„è½¬æ¢ï¼‰ï¼Œè½¬æ¢å¤±è´¥çš„è¯ä¼šæŠ›å‡ºä¸€ä¸ªç¼–è¯‘é”™è¯¯ï¼›                                                                                                                                                                                                                                                                                                                                 |
| `const_cast`       | ç”¨äº **const ä¸é const**ã€**volatile ä¸é volatile** ä¹‹é—´çš„è½¬æ¢ã€‚                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `reinterpret_cast` | é«˜åº¦å±é™©çš„è½¬æ¢ï¼Œè¿™ç§è½¬æ¢ä»…ä»…æ˜¯å¯¹äºŒè¿›åˆ¶ä½çš„é‡æ–°è§£é‡Šï¼Œä¸ä¼šå€ŸåŠ©å·²æœ‰çš„è½¬æ¢è§„åˆ™å¯¹æ•°æ®è¿›è¡Œè°ƒæ•´ï¼Œä½†æ˜¯å¯ä»¥å®ç°æœ€çµæ´»çš„ C++ ç±»å‹è½¬æ¢ã€‚å¯ä»¥è®¤ä¸ºæ˜¯ `static_cast` çš„ä¸€ç§è¡¥å……ï¼Œä¸€äº› static\_cast ä¸èƒ½å®Œæˆçš„è½¬æ¢ï¼Œå°±å¯ä»¥ç”¨ reinterpret\_cast æ¥å®Œæˆï¼Œä¾‹å¦‚**ä¸¤ä¸ªå…·ä½“ç±»å‹æŒ‡é’ˆä¹‹é—´çš„è½¬æ¢ã€int å’ŒæŒ‡é’ˆä¹‹é—´çš„è½¬æ¢**ï¼ˆæœ‰äº›ç¼–è¯‘å™¨åªå…è®¸ int è½¬æŒ‡é’ˆï¼Œä¸å…è®¸åè¿‡æ¥ï¼‰                                                                                                                                                                                                                                                                                               |
| `dynamic_cast`     | å€ŸåŠ© `RTTI`ï¼Œç”¨äºç±»å‹å®‰å…¨çš„å‘ä¸‹è½¬å‹ï¼ˆDowncastingï¼‰;ä¸ `static_cast` æ˜¯ç›¸å¯¹çš„ï¼Œ`dynamic_cast` æ˜¯â€œåŠ¨æ€è½¬æ¢â€çš„æ„æ€ï¼Œ`static_cast` æ˜¯â€œé™æ€è½¬æ¢â€çš„æ„æ€ã€‚`dynamic_cast` ä¼šåœ¨ç¨‹åºè¿è¡ŒæœŸé—´å€ŸåŠ© `RTTI` è¿›è¡Œç±»å‹è½¬æ¢ï¼Œè¿™å°±è¦æ±‚åŸºç±»å¿…é¡»åŒ…å«è™šå‡½æ•°ï¼Œç±»å‘ä¸Šè½¬å‹æ˜¯å®‰å…¨çš„ï¼ˆçˆ¶ç±»è½¬å­ç±»ï¼‰ï¼Œä¸åšè§£é‡Šï¼Œå‘ä¸‹è½¬å‹ä¸å®‰å…¨ï¼šæ¯ä¸ªç±»éƒ½ä¼šåœ¨å†…å­˜ä¸­ä¿å­˜ä¸€ä»½ç±»å‹ä¿¡æ¯ï¼Œç¼–è¯‘å™¨ä¼šå°†å­˜åœ¨ç»§æ‰¿å…³ç³»çš„ç±»çš„ç±»å‹ä¿¡æ¯ä½¿ç”¨æŒ‡é’ˆâ€œè¿æ¥â€èµ·æ¥ï¼Œä»è€Œå½¢æˆä¸€ä¸ª**ç»§æ‰¿é“¾**ï¼šåŒä¸€ä¸ªç±»çš„ä¸åŒå¯¹è±¡æŒ‡å‘åŒä¸€ä¸ªç±»å‹ä¿¡æ¯ï¼Œæœ‰ç»§æ‰¿å…³ç³»çš„ç±»å‹ä¿¡æ¯ç»„æˆä¸€æ¡é“¾ã€‚å½“ä½¿ç”¨ `dynamic_cast` å¯¹æŒ‡é’ˆè¿›è¡Œç±»å‹è½¬æ¢æ—¶ï¼Œç¨‹åºä¼šå…ˆæ‰¾åˆ°è¯¥**æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡**ï¼Œå†æ ¹æ®å¯¹è±¡æ‰¾åˆ°**å½“å‰ç±»ï¼ˆæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡æ‰€å±çš„ç±»ï¼‰çš„ç±»å‹ä¿¡æ¯**ï¼Œå¹¶ä»æ­¤èŠ‚ç‚¹å¼€å§‹**æ²¿ç€ç»§æ‰¿é“¾å‘ä¸Šéå†**ï¼Œå¦‚æœæ‰¾åˆ°äº†è¦è½¬åŒ–çš„ç›®æ ‡ç±»å‹ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ç§è½¬æ¢æ˜¯å®‰å…¨çš„ï¼Œå°±èƒ½å¤Ÿè½¬æ¢æˆåŠŸï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°è¦è½¬æ¢çš„ç›®æ ‡ç±»å‹ï¼ˆç›´åˆ°ç»§æ‰¿é“¾çš„é¡¶ç‚¹ï¼ˆæœ€é¡¶å±‚çš„åŸºç±»ï¼‰è¿˜æ²¡æœ‰é‡åˆ°ï¼‰ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ç§è½¬æ¢å­˜åœ¨è¾ƒå¤§çš„é£é™©ï¼Œå°±ä¸èƒ½è½¬æ¢ã€‚ |

> è¿™å››ä¸ªå…³é”®å­—çš„è¯­æ³•æ ¼å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå…·ä½“ä¸ºï¼š
>
> `xxx_cast<newType>(data)`
>
> `newType` æ˜¯è¦è½¬æ¢æˆçš„æ–°ç±»å‹ï¼Œ`data` æ˜¯è¢«è½¬æ¢çš„æ•°æ®
